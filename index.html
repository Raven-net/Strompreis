<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strompreis Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-green: #4ade80;
            --accent-red: #f87171;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            /* Verhindert "Bounce" beim Scrollen auf iOS */
            overscroll-behavior: none;
        }

        .app-container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            box-sizing: border-box;
            padding-bottom: 80px;
            /* Platz für Footer Nav */
        }

        header {
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        h1 {
            font-size: 1.1rem;
            color: var(--text-muted);
            font-weight: 500;
            margin: 0;
            letter-spacing: 0.5px;
        }

        /* --- PREIS KARTE --- */
        .current-price-card {
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s;
        }

        .price-value {
            font-size: 4.5rem;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -2px;
            margin: 10px 0;
            text-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
        }

        .price-unit {
            font-size: 1.1rem;
            color: var(--text-muted);
            display: block;
        }

        .avg-info {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- DIAGRAMM SECTION --- */
        .chart-section {
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .chart-nav-btn {
            background: none;
            border: none;
            color: var(--text-main);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .chart-nav-btn.active {
            opacity: 1;
            color: var(--accent-green);
        }

        .chart-wrapper {
            height: 350px;
            position: relative;
            width: 100%;
        }

        /* Swipe Indikator */
        .swipe-hint {
            text-align: center;
            font-size: 0.7rem;
            color: #444;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 5px;
            align-items: center;
        }

        .dot {
            width: 6px;
            height: 6px;
            background: #333;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .dot.active {
            background: var(--text-main);
        }

        /* --- HISTORY TAB --- */
        #history-view {
            display: none;
        }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 5px;
            display: flex;
            gap: 5px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .nav-item {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            background: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item.active {
            background: var(--text-main);
            color: #000;
            font-weight: 600;
        }

        /* Helper */
        .text-green {
            color: var(--accent-green);
        }

        .text-red {
            color: var(--accent-red);
        }

        #loading {
            margin-top: 50px;
            text-align: center;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <div class="app-container">
        <header>
            <h1><i class="bi bi-lightning-charge-fill" style="color:#eab308"></i> EPEX Spot Monitor</h1>
        </header>

        <div id="loading">Lade Marktdaten...</div>

        <div id="live-view" style="display: none;">
            <div class="current-price-card">
                <span
                    style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; color: #888;">Aktuell</span>
                <div id="price-display" class="price-value">--</div>
                <span class="price-unit">Cent / kWh</span>

                <div class="avg-info">
                    <span id="avg-label">Ø Heute</span>
                    <span id="avg-display" style="font-weight: 700; color: #fff;">--</span>
                </div>
            </div>

            <div class="chart-section" id="chart-card">
                <div class="chart-header">
                    <button id="btn-prev-day" class="chart-nav-btn"><i class="bi bi-chevron-left"></i></button>
                    <span id="chart-date-title" class="chart-title">Heute</span>
                    <button id="btn-next-day" class="chart-nav-btn"><i class="bi bi-chevron-right"></i></button>
                </div>

                <div class="chart-wrapper">
                    <canvas id="priceChart"></canvas>
                </div>

                <div class="swipe-hint">
                    <span class="dot active" id="dot-0"></span>
                    <span class="dot" id="dot-1"></span>
                </div>
            </div>

            <p style="text-align: center; font-size: 0.7rem; color: #555; margin-top: 10px;">
                Tippe auf das Diagramm für Details.<br>Wische links/rechts für Morgen/Heute.
            </p>
        </div>

        <div id="history-view">
            <div class="chart-section">
                <div class="chart-header">
                    <span class="chart-title">Rückblick (30 Tage)</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="historyChart"></canvas>
                </div>
                <p style="text-align: center; font-size: 0.7rem; color: #555; margin-top: 15px;">
                    Durchschnittspreise der letzten 30 Tage.<br>
                    (12-Monats-Daten erfordern Server-Backend)
                </p>
            </div>
        </div>

    </div>

    <div class="bottom-nav" id="bottom-nav" style="display:none">
        <button class="nav-item active" onclick="switchTab('live')">Live</button>
        <button class="nav-item" onclick="switchTab('history')">Historie</button>
    </div>

    <script>
        // --- GLOBALE VARIABLEN ---
        let rawData = [];
        let daysData = {}; // Speichert Daten gruppiert nach Datum "YYYY-MM-DD"
        let sortedDates = []; // Array der verfügbaren Datumsschlüssel
        let currentDayIndex = 0; // 0 = Heute, 1 = Morgen
        let liveChartInstance = null;
        let historyChartInstance = null;
        let averagePriceToday = 0;

        // --- INIT ---
        async function initApp() {
            try {
                // 1. Live Daten laden (Ab heute 00:00)
                const now = new Date();
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

                const response = await fetch(`https://api.awattar.de/v1/marketdata?start=${startOfToday}`);
                const json = await response.json();
                rawData = json.data;

                if (!rawData || rawData.length === 0) throw new Error("Keine Daten.");

                // 2. Daten verarbeiten & gruppieren
                processData(rawData);

                // 3. UI Starten
                document.getElementById('loading').style.display = 'none';
                document.getElementById('live-view').style.display = 'block';
                document.getElementById('bottom-nav').style.display = 'flex';

                // Initialen Tag rendern
                renderDay(0);
                updateCurrentPriceDisplay();

                // Swipe Gesten aktivieren
                initSwipeHandlers();

            } catch (e) {
                document.getElementById('loading').innerText = "Fehler: " + e.message;
            }
        }

        // --- DATEN VERARBEITUNG ---
        function processData(data) {
            daysData = {};
            data.forEach(item => {
                const date = new Date(item.start_timestamp);
                // Key erstellen: "2023-10-27"
                const key = date.toISOString().split('T')[0];

                if (!daysData[key]) daysData[key] = [];
                daysData[key].push({
                    timestamp: item.start_timestamp,
                    price: item.marketprice / 10, // Cent/kWh
                    hour: date.getHours()
                });
            });

            // Sortierte Keys (Heute, Morgen...)
            sortedDates = Object.keys(daysData).sort();
        }

        // --- LIVE VIEW LOGIC ---
        function renderDay(index) {
            if (index < 0 || index >= sortedDates.length) return;
            currentDayIndex = index;

            const dateKey = sortedDates[index];
            const dayPoints = daysData[dateKey];

            // Buttons updaten
            document.getElementById('btn-prev-day').classList.toggle('active', index > 0);
            document.getElementById('btn-next-day').classList.toggle('active', index < sortedDates.length - 1);

            // Dots updaten
            document.getElementById('dot-0').className = index === 0 ? 'dot active' : 'dot';
            document.getElementById('dot-1').className = index === 1 ? 'dot active' : 'dot';

            // Titel setzen
            const dateObj = new Date(dayPoints[0].timestamp);
            const isToday = new Date().toDateString() === dateObj.toDateString();
            const dateStr = dateObj.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' });
            document.getElementById('chart-date-title').innerText = isToday ? "Heute" : (index === 1 ? "Morgen (" + dateStr + ")" : dateStr);

            // Durchschnitt berechnen
            let sum = 0;
            dayPoints.forEach(p => sum += p.price);
            const avg = sum / dayPoints.length;

            // UI Durchschnitt Update (nur wenn wir auf dem aktuellen Tag sind, sonst oben anpassen)
            if (isToday) {
                averagePriceToday = avg;
                document.getElementById('avg-label').innerText = "Ø Heute";
                document.getElementById('avg-display').innerText = avg.toFixed(2) + " ct";
            } else {
                document.getElementById('avg-label').innerText = "Ø Dieser Tag";
                document.getElementById('avg-display').innerText = avg.toFixed(2) + " ct";
            }

            // Chart Daten vorbereiten
            const labels = dayPoints.map(p => p.hour.toString().padStart(2, '0') + " Uhr");
            const prices = dayPoints.map(p => p.price);

            // Durchschnittslinie (Array mit gleichem Wert)
            const avgLine = new Array(prices.length).fill(avg);

            drawLiveChart(labels, prices, avgLine);
        }

        function drawLiveChart(labels, data, avgLine) {
            const ctx = document.getElementById('priceChart').getContext('2d');

            if (liveChartInstance) liveChartInstance.destroy();

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 350);
            gradient.addColorStop(0, 'rgba(248, 113, 113, 0.7)');   // Rot
            gradient.addColorStop(0.5, 'rgba(250, 204, 21, 0.4)'); // Gelb
            gradient.addColorStop(1, 'rgba(74, 222, 128, 0.1)');   // Grün

            liveChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Preis',
                            data: data,
                            borderColor: '#e0e0e0',
                            borderWidth: 3,
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHitRadius: 25,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Ø Schnitt',
                            data: avgLine,
                            borderColor: 'rgba(255, 255, 255, 0.3)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1f1f1f',
                            titleColor: '#888',
                            bodyColor: '#fff',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            filter: function (tooltipItem) {
                                // HIER IST DIE ÄNDERUNG: Nur Dataset 0 (Preis) anzeigen, nicht Durchschnitt
                                return tooltipItem.datasetIndex === 0;
                            },
                            callbacks: {
                                label: (ctx) => {
                                    return ctx.parsed.y.toFixed(2) + ' ct/kWh';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: false }, // X-Achse ausblenden für cleaneren Look
                        y: {
                            position: 'right',
                            grid: { color: '#333' },
                            ticks: { color: '#666' }
                        }
                    }
                }
            });
        }

        function updateCurrentPriceDisplay() {
            const now = new Date();
            const currentTs = now.getTime();

            // Suche den aktuellen Punkt in ALLEN geladenen Daten
            let currentPoint = rawData.find(p => currentTs >= p.start_timestamp && currentTs < p.end_timestamp);

            // Fallback: Wenn keine exakte Stunde gefunden (z.B. API Verzögerung), nimm letzten
            if (!currentPoint && rawData.length > 0) currentPoint = rawData[0]; // Nur Placeholder

            if (currentPoint) {
                const price = currentPoint.marketprice / 10;
                const el = document.getElementById('price-display');
                el.innerText = price.toFixed(2);

                // Farbe Logik: Teurer als Tagesdurchschnitt = Rot
                // Wir nehmen den Durchschnitt von "Heute" (Tag 0)
                let avg = 0;
                if (sortedDates.length > 0) {
                    const todayPoints = daysData[sortedDates[0]];
                    const sum = todayPoints.reduce((a, b) => a + b.price, 0);
                    avg = sum / todayPoints.length;
                }

                if (price <= avg) {
                    el.className = "price-value text-green";
                } else {
                    el.className = "price-value text-red";
                }
            }
        }

        // --- SWIPE LOGIC ---
        function initSwipeHandlers() {
            const el = document.getElementById('chart-card');
            let touchStartX = 0;
            let touchEndX = 0;

            el.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            el.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const threshold = 50;
                if (touchEndX < touchStartX - threshold) {
                    // Swipe Left -> Next Day
                    if (currentDayIndex < sortedDates.length - 1) renderDay(currentDayIndex + 1);
                }
                if (touchEndX > touchStartX + threshold) {
                    // Swipe Right -> Prev Day
                    if (currentDayIndex > 0) renderDay(currentDayIndex - 1);
                }
            }

            // Button Click Handler
            document.getElementById('btn-next-day').onclick = () => renderDay(currentDayIndex + 1);
            document.getElementById('btn-prev-day').onclick = () => renderDay(currentDayIndex - 1);
        }

        // --- HISTORY TAB & LOGIC ---
        let historyLoaded = false;

        async function loadHistory() {
            if (historyLoaded) return;

            // Wir laden die letzten 30 Tage
            // API Trick: Startdatum = Heute - 30 Tage
            const now = new Date();
            const past = new Date();
            past.setDate(now.getDate() - 30);

            try {
                const response = await fetch(`https://api.awattar.de/v1/marketdata?start=${past.getTime()}`);
                const json = await response.json();
                const data = json.data;

                // Daten aggregieren auf TAGES-Durchschnitt
                // Map: "YYYY-MM-DD" -> {sum: 0, count: 0}
                const dailyAvgs = {};

                data.forEach(item => {
                    const dateStr = new Date(item.start_timestamp).toLocaleDateString('de-DE');
                    if (!dailyAvgs[dateStr]) dailyAvgs[dateStr] = { sum: 0, count: 0 };
                    dailyAvgs[dateStr].sum += item.marketprice;
                    dailyAvgs[dateStr].count++;
                });

                const labels = [];
                const values = [];

                Object.keys(dailyAvgs).forEach(date => {
                    labels.push(date.substring(0, 6)); // Nur Tag.Monat
                    const avg = (dailyAvgs[date].sum / dailyAvgs[date].count) / 10; // in Cent
                    values.push(avg);
                });

                drawHistoryChart(labels, values);
                historyLoaded = true;

            } catch (e) {
                console.error(e);
            }
        }

        function drawHistoryChart(labels, values) {
            const ctx = document.getElementById('historyChart').getContext('2d');

            // Farbe basierend auf Wert (Balken)
            const colors = values.map(v => v < 10 ? '#4ade80' : (v < 20 ? '#facc15' : '#f87171'));

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø Preis (ct)',
                        data: values,
                        backgroundColor: colors,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#666', maxTicksLimit: 10 }, grid: { display: false } },
                        y: { grid: { color: '#333' }, ticks: { color: '#666' } }
                    }
                }
            });
        }

        // --- NAVIGATION TABS ---
        window.switchTab = function (tab) {
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            if (tab === 'live') {
                document.getElementById('live-view').style.display = 'block';
                document.getElementById('history-view').style.display = 'none';
                document.querySelector('button[onclick="switchTab(\'live\')"]').classList.add('active');
            } else {
                document.getElementById('live-view').style.display = 'none';
                document.getElementById('history-view').style.display = 'block';
                document.querySelector('button[onclick="switchTab(\'history\')"]').classList.add('active');
                loadHistory(); // Daten laden beim ersten Klick
            }
        }

        // App Start
        initApp();
        // Auto-Refresh alle 5 Minuten für aktuellen Preis
        setInterval(updateCurrentPriceDisplay, 300000);

    </script>
</body>

</html>